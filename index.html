<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Will Builder ‚Äî Drafting</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="./wizard.css" />
  <style>
    /* Layout helpers specific to this page (kept small) */
  .app { min-height: 100dvh; display: grid; grid-template-rows: 1fr auto; }
    .dock-actions { margin-left:auto; display:flex; gap:.5rem; }
    .muted { font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; font-size:.75rem; color:var(--muted); }

    /* Full document letter view */
    dialog#letter { 
      width: min(1000px, 96vw); 
      max-height: 90vh; 
      border: 1px solid var(--line); 
      border-radius: 12px; 
      background: var(--panel); 
      color: var(--ink); 
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
      padding: 0;
      overflow: hidden;
    }
    dialog#letter::backdrop { background: rgba(15,23,42,.65); }
    .letter-inner { 
      padding: 0.75rem 1rem; 
      position: relative; 
      display: flex; 
      flex-direction: column; 
      height: 100%; 
      max-height: 90vh;
    }
    .letter-paper { 
      background: #fff; 
      color: #000; 
      padding: 1in; 
      font-family: "Times New Roman", Times, serif; 
      font-size: 12pt; 
      line-height: 1.5; 
      border-radius: 4px; 
      overflow-y: auto;
      flex: 1;
    }
    
    /* Terminal mode styling for will document */
    .terminal-mode {
      background: #0f1115 !important;
      color: #e5e7eb !important;
      padding: 1.5rem !important;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace !important;
      font-size: 13px !important;
      line-height: 1.55 !important;
      border-radius: 4px;
      min-height: 300px;
      overflow-y: auto;
      flex: 1;
    }
    
    /* Terminal mode will document structure */
    .terminal-mode .will-header h1 {
      display: block;
      font-weight: 800;
      margin: 0 0 1rem 0;
      color: #e5e7eb !important;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace !important;
      font-size: 13px !important;
      text-transform: none;
      line-height: 1.55;
    }
    
    .terminal-mode .will-article,
    .terminal-mode .will-introduction {
      margin: 0.5rem 0;
    }
    
    .terminal-mode .article-title {
      display: block;
      font-weight: 800;
      letter-spacing: .02em;
      margin: 1rem 0 0.5rem 0;
      color: #e5e7eb !important;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace !important;
      font-size: 13px !important;
      text-transform: none;
      line-height: 1.55;
    }
    
    .terminal-mode .article-content,
    .terminal-mode .introduction-content {
      color: #e5e7eb !important;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace !important;
      font-size: 13px !important;
      margin-left: 0;
      margin-top: 0;
      margin-bottom: 0;
    }
    
    .terminal-mode .article-content p,
    .terminal-mode .introduction-content p {
      margin: 0 0 0.5rem 0;
      color: #e5e7eb !important;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace !important;
      font-size: 13px !important;
      text-align: left;
      line-height: 1.55;
    }
    
    .terminal-mode .article-content p:last-child,
    .terminal-mode .introduction-content p:last-child {
      margin-bottom: 0;
    }
    
    .terminal-mode .placeholder-content {
      font-style: italic;
      color: #9ca3af !important;
    }
    
    .terminal-mode em {
      font-style: normal;
      color: #c7d2fe !important;
    }
    
    .terminal-mode .ph {
      background: rgba(164,120,100,.15);
      color: #A47864 !important;
      font-weight: 500;
      border-radius: 3px;
      padding: 0 2px;
    }
    
    .terminal-mode .ph-filled {
      background: transparent;
      color: #e5e7eb !important;
      border-bottom: 1px dashed #A47864;
    }
    
    .terminal-mode .token-highlight {
      padding: 0 3px;
      border-radius: 3px;
      background: rgba(15, 23, 42, 0.4);
    }
    
    .terminal-mode .token-highlight.token-missing {
      color: #f87171 !important;
    }
    
    .terminal-mode .token-highlight.token-filled {
      color: #34d399 !important;
    }
    
    /* Override all nested elements in terminal mode */
    .terminal-mode * {
      color: #e5e7eb !important;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace !important;
      font-size: 13px !important;
    }
    
  /* Sticky toolbar for close control (always visible while scrolling) */
  .letter-toolbar { 
    position: sticky; 
    top: 0; 
    z-index: 20; 
    display: flex; 
    justify-content: flex-end; 
    align-items: center; 
    gap: .5rem; 
    padding: 0.5rem 0 0.5rem 0; 
    margin-bottom: 0.5rem;
    background: var(--panel);
    flex-shrink: 0;
  }
  /* add a subtle backdrop to ensure contrast over page content */
  .letter-toolbar::before { 
    content: ""; 
    position: absolute; 
    inset: 0 0 auto 0; 
    height: 100%; 
    background: var(--panel); 
    opacity: 1; 
    pointer-events: none; 
    border-radius: 8px 8px 0 0; 
  }
  .letter-toolbar > * { position: relative; z-index: 1; }
    
    /* Will document structure styling for 12pt Times New Roman */
    .letter-paper .will-header h1 { font-size: 12pt; font-weight: bold; text-align: center; margin: 0 0 1.5rem 0; text-transform: uppercase; color: #000; }
    .letter-paper .article-title { font-size: 12pt; font-weight: bold; margin: 1.5rem 0 1rem 0; text-transform: uppercase; color: #000; }
    .letter-paper .will-article[data-section="debts"] .article-title { margin-top: 1.5rem; } /* Extra space before Article I */
    .letter-paper .article-content { margin-left: 1rem; }
    .letter-paper .article-content p { margin: 0 0 0.75rem 0; text-align: justify; color: #000; }
    .letter-paper .introduction-content p { margin: 0 0 0.75rem 0; text-align: justify; color: #000; }
    .letter-paper .placeholder-content { font-style: italic; color: #000; background: transparent; }
    
    /* Override all token highlighting and colors to uniform black */
    .letter-paper .ph, .letter-paper .ph-filled, .letter-paper .token-highlight, .letter-paper .token-missing, .letter-paper em, .letter-paper strong { 
      color: #000 !important; 
      background: transparent !important; 
      border: none !important; 
      font-style: normal !important; 
      font-weight: normal !important;
      font-family: "Times New Roman", Times, serif !important;
    }
    .letter-paper * { 
      color: #000 !important; 
      font-family: "Times New Roman", Times, serif !important;
      font-size: 12pt !important;
    }
  
  /* Terminal-style preview when shown in dialog */
  #letterPaper .preview-terminal {
    background: #0f1115;
    color: #e5e7eb;
    border: 1px solid #273142;
    border-radius: 8px;
    padding: 1.5rem;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: 13px;
    line-height: 1.55;
    overflow: auto;
    max-height: calc(90vh - 120px);
    white-space: pre-wrap;
    word-break: break-word;
  }
  
  /* Ensure terminal styles are applied in the dialog */
  #letterPaper .preview-terminal .h-article {
    display: block;
    font-weight: 800;
    letter-spacing: .02em;
    text-transform: none;
    margin: 12px 0 6px;
    color: #e5e7eb;
  }
  
  #letterPaper .preview-terminal .h-title {
    display: block;
    font-weight: 800;
    margin-bottom: 8px;
    color: #e5e7eb;
  }
  
  #letterPaper .preview-terminal em {
    font-style: normal;
    color: #c7d2fe;
  }
  
  #letterPaper .preview-terminal .ph {
    background: rgba(164,120,100,.15);
    color: #A47864;
    font-weight: 500;
    border-radius: 3px;
    padding: 0 2px;
  }
  
  #letterPaper .preview-terminal .ph-filled {
    background: transparent;
    color: #e5e7eb;
    border-bottom: 1px dashed #A47864;
  }
  
  #letterPaper .preview-terminal .token-highlight {
    padding: 0 3px;
    border-radius: 3px;
    background: rgba(15, 23, 42, 0.4);
  }
  
  #letterPaper .preview-terminal .token-highlight.token-missing {
    color: #f87171;
  }
  
  #letterPaper .preview-terminal .token-highlight.token-filled {
    color: #34d399;
  }
  
  /* (removed) Export Preview dialog styling */
  /* Terminal-style preview in left rail */
  .terminal-preview { background:#0b1020; color:#b4f1ff; border:1px solid #1f2a44; border-radius:8px; padding:.75rem; font: 12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; line-height:1.35; white-space:pre; overflow:auto; min-height: 280px; height: clamp(320px, 50vh, 720px); max-height: 65vh; }
  .terminal-preview .muted { color:#6ea0b3; }
  .terminal-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:.5rem; }
  .terminal-header .title { font-weight:600; color: var(--ink); }
  .terminal-actions { display:flex; gap:.5rem; }
  .terminal-actions .btn.btn-sm {
    background:#122039; color:#d9fbff; border-color:#233659;
    padding: .2rem .5rem; font-size: .72rem; line-height: 1;
    border-radius: 6px; min-height: 26px; width: auto;
  }
  /* Reuse icon-close style for dialog X */
  .icon-close.letter-close,
  .letter-toolbar .icon-close {
    background: transparent; border: 1px solid var(--line-2); color: var(--muted);
    width: 28px; height: 28px; border-radius: 6px; padding: 0; font-size: 16px;
  }
  .icon-close.letter-close:hover,
  .letter-toolbar .icon-close:hover { background: var(--panel-alt); color: var(--ink); border-color: var(--brand); }
    /* Compact close icon for rail headers */
    .rail-card-header .icon-close {
      background: transparent; border: 1px solid var(--line-2); color: var(--muted);
      width: 26px; height: 26px; border-radius: 6px; padding: 0;
      display: inline-flex; align-items: center; justify-content: center;
      font-size: 14px; line-height: 1; cursor: pointer;
    }
    .rail-card-header .icon-close:hover { background: var(--panel-alt); color: var(--ink); border-color: var(--brand); }
  /* Add breathing room above the export preview card */
  .rail-subcard { margin-top: 1rem; }
    
    /* Hide duplicate Print Preview button on desktop */
    .mobile-print-preview {
      display: none;
    }
    
    /* Hide minimize button on desktop */
    .preview-minimize-btn {
      display: none;
    }
    
    /* Show Preview floating button (hidden by default, shown on mobile when preview minimized) */
    .show-preview-btn {
      display: none;
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 200;
      background: var(--brand);
      color: #fff;
      border: 1px solid var(--brand-dark);
      border-radius: 8px;
      padding: 0.6rem 1rem;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(31, 59, 115, 0.3);
      transition: all 0.15s ease;
    }
    
    .show-preview-btn:hover {
      background: var(--brand-dark);
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(31, 59, 115, 0.4);
    }
    
    /* Mobile-specific adjustments for print preview dialog */
    @media (max-width: 900px) {
      /* Show duplicate Print Preview button on mobile */
      .mobile-print-preview {
        display: inline-flex;
      }
      
      /* Force buttons to be side by side on mobile (override wizard.css column layout) */
      .preview-header .preview-actions {
        display: flex !important;
        flex-direction: row !important;
        gap: 0.5rem !important;
        flex-wrap: nowrap;
        align-items: center;
      }
      
      /* Make buttons compact to fit side by side */
      .preview-actions .btn-sm {
        font-size: 0.8rem;
        padding: 0.5rem 0.85rem;
        white-space: nowrap;
        flex: 1;
        min-width: 0;
      }
      
      /* Show and style minimize button on mobile */
      .preview-minimize-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: 1px solid var(--line-2);
        color: var(--muted);
        width: 32px;
        height: 32px;
        border-radius: 6px;
        padding: 0;
        font-size: 20px;
        font-weight: 300;
        line-height: 1;
        cursor: pointer;
        transition: all 0.15s ease;
        flex-shrink: 0;
      }
      
      .preview-minimize-btn:hover {
        background: var(--panel-alt);
        color: var(--ink);
        border-color: var(--brand);
      }
      
      dialog#letter { 
        width: 100vw; 
        max-height: 100vh; 
        height: 100vh;
        border-radius: 0;
        padding: 0;
        margin: 0;
        max-width: 100vw;
        inset: 0;
      }
      .letter-inner { 
        padding: 0.5rem; 
        height: 100vh;
        max-height: 100vh;
      }
      .letter-toolbar {
        padding: 0.75rem 0.5rem;
        margin-bottom: 0.5rem;
      }
      .letter-paper { 
        padding: 1rem; 
        font-size: 11pt; 
      }
      .letter-paper * { font-size: 11pt !important; }
      .terminal-mode {
        padding: 1rem !important;
        font-size: 12px !important;
      }
      .terminal-mode * {
        font-size: 12px !important;
      }
      
      /* Mobile form field optimizations */
      .form-field {
        gap: 0.35rem;
      }
      
      .form-field label {
        min-width: 7rem;
        max-width: 7rem;
        font-size: 0.8rem;
      }
      
      .form-field input,
      .form-field select,
      .form-field textarea {
        padding: 0.5rem 0.65rem;
        font-size: 0.95rem;
      }
      
      /* Reduce heights of input fields */
      input, select {
        min-height: 38px;
      }
      
      /* Tighten up segmented controls */
      .seg-control {
        padding: 0.25rem;
      }
      
      .seg-btn {
        padding: 0.45rem 0.75rem;
        font-size: 0.85rem;
      }
      
      /* Optimize button spacing for +Middle name/initial and +Suffix */
      .toggle-extra-btn {
        padding: 0.35rem 0.6rem;
        font-size: 0.75rem;
      }
      
      /* Optimize segmented control layout for mobile */
      /* Make rows with segmented controls stack vertically */
      .row:has(.seg-label-spacer) {
        display: flex !important;
        flex-direction: column !important;
        gap: 0.5rem !important;
      }
      
      .seg-label-spacer {
        grid-column: auto !important;
        justify-content: flex-start !important;
      }
      
      .seg-label-spacer label {
        text-align: left !important;
        min-width: auto !important;
        max-width: none !important;
        font-size: 0.8rem !important;
        font-weight: 600 !important;
      }
      
      .seg-control-wrapper {
        grid-column: auto !important;
        display: block !important;
        padding-left: 0 !important;
      }
      
      .seg-field {
        display: block !important;
      }
      
      /* Better mobile styling for segmented controls */
      .seg-control {
        display: inline-flex !important;
        width: auto !important;
        background: var(--panel-alt) !important;
        border: 1px solid var(--line-2) !important;
        border-radius: 8px !important;
        overflow: hidden !important;
      }
      
      .seg-btn {
        background: transparent !important;
        border: none !important;
        border-radius: 0 !important;
        padding: 0.5rem 1rem !important;
        font-size: 0.85rem !important;
        font-weight: 500 !important;
        color: var(--ink) !important;
        transition: all 0.15s ease !important;
        min-width: 70px !important;
      }
      
      .seg-btn + .seg-btn {
        border-left: 1px solid var(--line-2) !important;
      }
      
      .seg-btn:hover {
        background: var(--panel) !important;
      }
      
      .seg-btn.active {
        background: var(--brand) !important;
        color: #fff !important;
        font-weight: 600 !important;
      }
      
      /* Tighten panel spacing */
      .panel {
        padding: 0.75rem;
      }
      
      .center-pane .panel h2 {
        font-size: 1.25rem;
        margin-bottom: 0.75rem;
      }
      
      /* Reduce gap in row layouts */
      .row {
        gap: 0.5rem;
      }
      
      .dock-head { align-items: flex-start; flex-direction: column; }
      .dock-actions { margin-left: 0; }
    }
  </style>
</head>
<body>
  <!-- Brand ribbon lives under the app chrome -->
  <div class="brand-ribbon" aria-hidden="true">
    <div class="brand-inner">
      <img src="../assets/evergreen-logo.jpeg" alt="Evergreen Legal logo featuring a stylized evergreen tree, conveying professionalism and trust in a legal context" class="brand-logo" />
      <img src="../assets/temp-textLogo.jpeg" alt="Weldon Law text logo, displaying the words Weldon Law in a modern font, set within a clean and welcoming interface" class="brand-text-logo" />
      <div class="brand-tag">Beta</div>
      <div class="brand-spacer"></div>
    </div>
    <!-- Tagline inside the ribbon, to the right of the emoji -->
    <div class="brand-tagline" aria-hidden="true">
      <span>It‚Äôs your sentence.</span>
      <span>It should be your signature.</span>
    </div>
  </div>

  <!-- Show Preview floating button (mobile only, appears when preview is minimized) -->
  <button class="show-preview-btn" id="showPreviewBtn" style="display: none;">
    Show Preview
  </button>

  <!-- Hidden Action Button (centered in ribbon, behind center pane initially) -->
  <div class="hidden-action-zone">
    <img src="../assets/willWizard.ico" alt="Advanced Options" id="hiddenActionButton" class="wizard-icon">
  </div>
  
  <!-- Wizard Message -->
  <div class="wizard-message" id="wizardMessage">
    <div class="wizard-text">What's up boss?</div>
    <select class="wizard-dropdown" id="wizardDropdown">
      <option value="">Choose an option...</option>
      <option value="import-export">Import/Export (Show me)</option>
      <option value="preview-options">Preview options (Show me)</option>
      <option value="report-by-tab">Generate clauses report (by tab)</option>
      <option value="export-clauses-only">Export clauses (confidential)</option>
      <option value="reset-intake">Clear fields and reset defaults</option>
      <option value="load-homer">Load Homer</option>
    </select>
    <button class="wizard-close-btn" id="wizardCloseBtn">Nothing, go away!</button>
  </div>
  
  <div class="app">
    <!-- 3-RAIL LAYOUT: Left (IO/Utils) | Center (Forms) | Right (Preview) -->
    <main class="container">
      <div class="layout">
        
        <!-- LEFT RAIL: IO & Utilities -->
        <aside class="left-pane" aria-label="IO and Utilities">
          <!-- Placeholder content shown until a tool is revealed -->
          <div class="rail-card rail-placeholder" id="leftPlaceholder">
            <div class="rail-card-header">Tools</div>
            <p class="muted">Use the wizard icon in the ribbon to reveal tools here.</p>
          </div>

          <!-- IO tools (hidden by default) -->
          <div class="rail-card" id="ioCard" hidden>
            <div class="rail-card-header" style="display:flex;align-items:center;gap:.5rem;justify-content:space-between">
              <span>IO</span>
              <div style="display:flex;align-items:center;gap:.5rem;">
                <div class="io-toggle" role="group" aria-label="Import/Export mode">
                  <button class="btn btn-sm" id="ioShowImports" aria-pressed="false">Imports</button>
                  <button class="btn btn-sm" id="ioShowExports" aria-pressed="false">Exports</button>
                </div>
                <button type="button" class="icon-close" id="closeIoCard" aria-label="Close IO" title="Close">√ó</button>
              </div>
            </div>

            <!-- Imports Section (hidden until toggled) -->
            <div id="ioImports" hidden>
              <button class="btn" id="importJsonFloating">ÔøΩ Import JSON</button>
              <button class="btn" id="importCsvBtn">üì• Import CSV</button>
              <input type="file" id="importCsvInput" accept=".csv,text/csv" hidden />
            </div>

            <!-- Exports Section (hidden until toggled) -->
            <div id="ioExports" hidden>
              <button class="btn" id="exportJsonBtn">üì§ Export JSON</button>
              <button class="btn" id="exportCsvBtn">üì§ Export CSV</button>
              <button class="btn" id="exportTextBtn">üìÑ Export Text (.txt)</button>
              <a class="btn" href="./export.html" target="_blank" style="text-align: center; text-decoration: none;">üìÑ Export Word (docx)</a>
            </div>

            <!-- Export JSON structure preview (shown only when Exports mode is active) -->
            <div id="exportStructureCard" class="rail-subcard" hidden>
              <div class="terminal-header">
                <div class="title">JSON Export Preview</div>
                <div class="terminal-actions">
                  <button class="btn btn-sm" id="copySkeletonBtn" title="Copy to clipboard">Copy</button>
                </div>
              </div>
              <pre class="terminal-preview" id="exportSkeletonPreview"><span class="muted">// Export structure will appear here‚Ä¶</span></pre>
            </div>
          </div>
          
          <!-- View tools (visible by default) -->
          <div class="rail-card" id="viewCard">
            <div class="rail-card-header" style="display:flex;align-items:center;justify-content:space-between;gap:.5rem;">
              <span>Preview</span>
              <button type="button" class="icon-close" id="closeViewCard" aria-label="Close Preview" title="Close">√ó</button>
            </div>
            <button class="btn" id="expandLetter">üñ®Ô∏è Print Preview</button>
            <button class="btn" id="expandLetterClausesOnly">ÔøΩÔ∏è Print Preview (Clauses Only)</button>
          </div>
        </aside>

        <!-- CENTER PANE: Intake Forms -->
        <section class="center-pane" id="intake-pane" aria-label="Intake">
          <div class="panel">
            <nav class="panel-tabs" aria-label="Wizard sections">
              <button class="mobile-tab-prev" id="mobileTabPrev" aria-label="Previous tab">‚Äπ</button>
              <div class="tabs tabs-panel" id="tabs-inline" data-tablist="wizard" role="tablist" aria-label="Articles"></div>
              <button class="mobile-tab-next" id="mobileTabNext" aria-label="Next tab">‚Ä∫</button>
            </nav>
            <h2 id="currentTabTitle">Intake Wizard</h2>
            <div id="tabContent">
              <!-- Dynamic tab content will be rendered here -->
              <p class="loading-message">Loading intake form...</p>
            </div>
          </div>
        </section>

        <!-- RIGHT RAIL: Will Preview -->
        <aside class="right-pane" id="preview-pane" aria-label="Will Preview">
          <div class="preview-card">
            <div class="preview-header">
              <h3>Will Preview</h3>
              <div class="preview-actions">
                <button class="btn btn-sm mobile-print-preview" id="expandLetterRightMobile" title="Expand Terminal Preview">
                  Terminal
                </button>
                <button class="btn btn-sm" id="expandLetterRight" title="Print Preview">
                  Print
                </button>
                <button class="preview-minimize-btn" id="previewMinimizeBtn" title="Minimize preview" aria-label="Minimize preview">
                  ‚àí
                </button>
              </div>
            </div>
            <div class="preview-content" id="preview-content">
              <!-- Unified will preview will be rendered here -->
              <p class="preview-loading">Preview loading...</p>
            </div>
          </div>

          <!-- Practice Notes Container -->
          <div class="practice-notes-container" id="practiceNotesContainer">
            <div class="practice-notes-header" id="practiceNotesHeader">
              <h4>Practice Notes</h4>
              <button class="practice-notes-toggle" id="practiceNotesToggle" aria-expanded="false" title="Expand practice notes">
                <span class="toggle-icon">‚ñ≤</span>
              </button>
            </div>
            <div class="practice-notes-content" id="practiceNotesContent">
              <div class="practice-notes-body">
                <p class="practice-notes-placeholder">Contextual guidance</p>
                <p class="practice-notes-coming-soon">
                  Client Information ‚Äî Practice notes coming soon
                </p>
              </div>
            </div>
          </div>
        </aside>

      </div>

      <!-- Mobile Jump to Preview Button (hidden on desktop) -->
      <div class="mobile-preview-jump">
        <button class="btn btn-mobile-jump" id="mobileJumpToPreview">
          Jump to Preview ‚Üì
        </button>
      </div>
    </main>
  </div>

  <!-- Letter view dialog -->
  <dialog id="letter">
    <div class="letter-inner">
      <div class="letter-toolbar">
        <button class="btn btn-sm" id="letterCopy" title="Copy document text">Copy</button>
        <button class="icon-close" id="letterClose" aria-label="Close letter">√ó</button>
      </div>
      <div class="letter-paper" id="letterPaper">
        <!-- full document goes here -->
      </div>
    </div>
  </dialog>

  <!-- (removed) Export Preview dialog -->

  <!-- Scripts -->
  <script type="module">
  import { initApp, App, Bus, renderTab, buildCanonicalIntake } from "./app.js";
    
    // Initialize the unified intake app
    await initApp();
    
    // Wizard message functionality
    const wizardIcon = document.getElementById('hiddenActionButton');
    const wizardMessage = document.getElementById('wizardMessage');
    const wizardDropdown = document.getElementById('wizardDropdown');
    const wizardCloseBtn = document.getElementById('wizardCloseBtn');
    let messageTimeout;
    
    // Helper to check if we're on mobile
    function isMobile() {
      return window.innerWidth <= 900;
    }
    
    function hideMessage() {
      wizardMessage.classList.remove('show');
      wizardMessage.classList.add('hide');
      wizardDropdown.value = ''; // Reset dropdown
    }
    
    function startHideTimer(delay = 5000) {
      if (messageTimeout) {
        clearTimeout(messageTimeout);
      }
      messageTimeout = setTimeout(hideMessage, delay);
    }
    
    // Smoothly scroll back to the position where the ribbon is hidden (desktop only)
    function scrollToRibbonHidden() {
      if (!isMobile() && maxScrollPosition !== null) {
        window.scrollTo({ top: maxScrollPosition, behavior: 'smooth' });
      }
    }

    // Immediately jump to the ribbon-hidden position (no smooth) ‚Äî useful when focus changes (e.g., new tab)
    function scrollToRibbonHiddenHard() {
      if (!isMobile() && maxScrollPosition !== null) {
        window.scrollTo(0, maxScrollPosition);
      }
    }
    
    wizardIcon.addEventListener('click', () => {
      // Show the message
      wizardMessage.classList.remove('hide');
      wizardMessage.classList.add('show');
      
      // Hide after 5 seconds (longer since there's a dropdown)
      startHideTimer();
    });
    
    // Handle dropdown selection
    wizardDropdown.addEventListener('change', async (e) => {
      const value = e.target.value;

      const leftPane = document.querySelector('.left-pane');
      const ioCard = document.getElementById('ioCard');
      const viewCard = document.getElementById('viewCard');
      const leftPlaceholder = document.getElementById('leftPlaceholder');
      const ioImports = document.getElementById('ioImports');
      const ioExports = document.getElementById('ioExports');
      const ioShowImports = document.getElementById('ioShowImports');
      const ioShowExports = document.getElementById('ioShowExports');

      const pulse = (el) => {
        if (!el) return;
        el.style.animation = 'pulse 1s ease-in-out';
        setTimeout(() => (el.style.animation = ''), 1000);
      };

      const showOnly = (which) => {
        // Hide both main tool cards, then show requested (keep placeholder visible)
        if (ioCard) ioCard.hidden = which !== 'io';
        if (viewCard) viewCard.hidden = which !== 'view';
      };

      const reveal = (which) => {
        showOnly(which);
        // Hide the Tools placeholder when a tool is explicitly selected
        if (leftPlaceholder) leftPlaceholder.hidden = true;
        leftPane?.scrollIntoView({ behavior: 'smooth' });
        pulse(which === 'io' ? ioCard : viewCard);
        hideMessage();
      };

      if (value === 'import-export') {
        reveal('io');
        // Default to Exports view when opening IO (also shows skeleton)
        setIoMode('exports');
          // Return to the ribbon-hidden scroll position
          scrollToRibbonHidden();
      } else if (value === 'preview-options') {
        reveal('view');
          // Return to the ribbon-hidden scroll position
          scrollToRibbonHidden();
      } else if (value === 'export-clauses-only') {
        // Fire a clauses-only export (unhydrated placeholders preserved)
        try {
          App?.exportClausesOnly?.();
        } catch (err) {
          console.error('Clauses-only export failed', err);
        }
        hideMessage();
          scrollToRibbonHidden();
      } else if (value === 'report-by-tab') {
        try {
          // Pre-scroll in case the browser defers scroll during new-tab open
          scrollToRibbonHiddenHard();
          await App?.runByTabReport?.();
          // Post-scroll (immediate) and schedule a small fallback to cover focus shifts
          scrollToRibbonHiddenHard();
          setTimeout(scrollToRibbonHiddenHard, 200);
        } catch (err) {
          console.error('Report generation failed', err);
          alert('Could not generate the by-tab report. See console for details.');
        }
        hideMessage();
        // Smooth follow-up for UX polish
        scrollToRibbonHidden();
      } else if (value === 'load-homer') {
        // Quick-load the Homer sample intake directly from sandbox
        try {
          await App?.loadIntakeFromUrl?.('../sandbox/homer-sample-intake.json', { sourceName: 'Homer sample' });
        } catch (err) {
          console.error('Quick-load failed', err);
          alert('Failed to load the Homer sample. See console for details.');
        }
        hideMessage();
          scrollToRibbonHidden();
      } else if (value === 'reset-intake') {
        // Clear fields and reset defaults in intake center pane
        try { localStorage.removeItem('intakeState'); } catch {}
        // Reset App state for intake-related data
        App.setState({ intake: {}, selectedClauses: {}, nameBank: [] });
        // Re-render current tab UI and preview
        const current = App.state.currentTab || 'testator';
        await renderTab(current);
        Bus.emit('preview-update', { forceImmediate: true });
        // Visual cue on center pane
        const centerPane = document.querySelector('.center-pane');
        centerPane?.scrollIntoView({ behavior: 'smooth' });
        pulse(centerPane);
        hideMessage();
          scrollToRibbonHidden();
      }
    });
    
    // Reset timer when dropdown is opened/focused
    wizardDropdown.addEventListener('focus', () => startHideTimer(8000));
    
    // Calculate and cache the maximum scroll position
    let maxScrollPosition = null;
    
    function calculateMaxScroll() {
      const centerPane = document.querySelector('.center-pane');
      if (centerPane) {
        const centerPaneRect = centerPane.getBoundingClientRect();
        const currentScrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const centerPaneTopFromPage = centerPaneRect.top + currentScrollTop;
        // Maintain a 10px buffer so the center pane top doesn't touch the browser edge
        maxScrollPosition = Math.max(0, centerPaneTopFromPage - 10);
      }
    }
    
    // Calculate max scroll on load and resize (only for desktop)
    if (!isMobile()) {
      calculateMaxScroll();
    }
    window.addEventListener('resize', () => {
      if (!isMobile()) {
        calculateMaxScroll();
      } else {
        maxScrollPosition = null; // Clear scroll limits on mobile
      }
    });

    // On initial load, start with the ribbon hidden by scrolling to the max allowed position (desktop only)
    if (!isMobile() && maxScrollPosition !== null) {
      // Use a microtask to ensure layout is settled
      Promise.resolve().then(() => {
        window.scrollTo(0, maxScrollPosition);
      });
    }
    
    // Enforce scroll limits (desktop only)
    window.addEventListener('scroll', () => {
      if (!isMobile() && maxScrollPosition !== null && window.pageYOffset > maxScrollPosition) {
        window.scrollTo(0, maxScrollPosition);
      }
    });
    
    // Handle close button click
    wizardCloseBtn.addEventListener('click', () => {
      hideMessage();
      
      // Scroll to the maximum allowed position
      if (maxScrollPosition !== null) {
        window.scrollTo({
          top: maxScrollPosition,
          behavior: 'smooth'
        });
      }
    });

    // IO toggle setup
  const ioImports = document.getElementById('ioImports');
  const ioExports = document.getElementById('ioExports');
  const ioShowImports = document.getElementById('ioShowImports');
  const ioShowExports = document.getElementById('ioShowExports');
  const closeIoCard = document.getElementById('closeIoCard');
  const closeViewCard = document.getElementById('closeViewCard');
  const leftPlaceholderRef = document.getElementById('leftPlaceholder');
  const ioCardRef = document.getElementById('ioCard');
  const viewCardRef = document.getElementById('viewCard');

    const exportStructureCard = document.getElementById('exportStructureCard');
    const exportSkeletonPreview = document.getElementById('exportSkeletonPreview');
    const copySkeletonBtn = document.getElementById('copySkeletonBtn');

    function prettyPrintJson(obj) {
      try { return JSON.stringify(obj, null, 2); } catch { return '{\n  /* error building preview */\n}'; }
    }

    function renderExportPreview() {
      const canonical = buildCanonicalIntake();
      const current = (App?.state?.intake) || {};
      // Merge current values over the canonical blank structure so order stays canonical
      const live = { ...canonical, ...current };
      exportSkeletonPreview.textContent = prettyPrintJson(live);
    }

    function setIoMode(mode) {
      const showImports = mode === 'imports';
      if (ioImports) ioImports.hidden = !showImports;
      if (ioExports) ioExports.hidden = showImports;
      ioShowImports?.setAttribute('aria-pressed', String(showImports));
      ioShowExports?.setAttribute('aria-pressed', String(!showImports));

      // Show or hide the export structure card, and refresh its content when switching to Exports
      if (exportStructureCard) exportStructureCard.hidden = showImports; // show when Exports
      if (!showImports) {
        renderExportPreview();
      }
    }

    // Helper: when no tool cards are visible, show the Tools placeholder again
    function updateToolsPlaceholderVisibility() {
      const noToolsVisible = (!!ioCardRef && ioCardRef.hidden) && (!!viewCardRef && viewCardRef.hidden);
      if (leftPlaceholderRef) leftPlaceholderRef.hidden = !noToolsVisible ? true : false;
    }

    closeIoCard?.addEventListener('click', () => {
      if (ioCardRef) ioCardRef.hidden = true;
      // Keep Preview as-is; show Tools placeholder only if nothing is visible
      updateToolsPlaceholderVisibility();
    });
    closeViewCard?.addEventListener('click', () => {
      if (viewCardRef) viewCardRef.hidden = true;
      updateToolsPlaceholderVisibility();
    });

    ioShowImports?.addEventListener('click', () => setIoMode('imports'));
    ioShowExports?.addEventListener('click', () => setIoMode('exports'));

    // (removed) Export popout preview wiring on export button clicks

    // Copy skeleton to clipboard
    copySkeletonBtn?.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(exportSkeletonPreview.textContent || '');
        copySkeletonBtn.textContent = 'Copied!';
        setTimeout(() => (copySkeletonBtn.textContent = 'Copy'), 1200);
      } catch {}
    });

    // Live-update the export preview on any intake change or state change
    const maybeRender = () => {
      // Only render if Exports mode is visible and the card is shown
      const exportsVisible = ioExports && !ioExports.hidden;
      const cardVisible = exportStructureCard && !exportStructureCard.hidden;
      if (exportsVisible && cardVisible) renderExportPreview();
    };
    Bus.on?.('form-change', maybeRender);
    Bus.on?.('state-change', maybeRender);
    Bus.on?.('preview-update', maybeRender);

    // Keyboard shortcuts: Alt+I (IO Imports), Alt+O (IO Exports), Alt+P (Preview)
    function showTool(which) {
      if (which === 'io') {
        if (ioCardRef) ioCardRef.hidden = false;
        if (viewCardRef) viewCardRef.hidden = true;
      } else if (which === 'view') {
        if (viewCardRef) viewCardRef.hidden = false;
        if (ioCardRef) ioCardRef.hidden = true;
      }
      if (leftPlaceholderRef) leftPlaceholderRef.hidden = true;
      updateToolsPlaceholderVisibility?.();
    }

    document.addEventListener('keydown', (e) => {
      // Ignore when typing in inputs/textareas/contenteditable
      const tag = (e.target?.tagName || '').toLowerCase();
      if (tag === 'input' || tag === 'textarea' || e.target?.isContentEditable) return;

      if (e.altKey && !e.ctrlKey && !e.metaKey) {
        // Alt+I ‚Üí IO (Imports)
        if (e.code === 'KeyI') {
          e.preventDefault();
          showTool('io');
          setIoMode('imports');
          scrollToRibbonHidden();
        }
        // Alt+O ‚Üí IO (Exports)
        else if (e.code === 'KeyO') {
          e.preventDefault();
          showTool('io');
          setIoMode('exports');
          scrollToRibbonHidden();
        }
        // Alt+P ‚Üí Preview
        else if (e.code === 'KeyP') {
          e.preventDefault();
          showTool('view');
          scrollToRibbonHidden();
        }
      }
    });
    
    // Mobile tab navigation with arrows
    if (isMobile()) {
      const prevBtn = document.getElementById('mobileTabPrev');
      const nextBtn = document.getElementById('mobileTabNext');
      const tabsContainer = document.querySelector('.panel-tabs .tabs');
      
      if (prevBtn && nextBtn && tabsContainer) {
        // Navigate to previous tab
        prevBtn.addEventListener('click', () => {
          const tabs = Array.from(tabsContainer.querySelectorAll('.tab'));
          const currentTab = tabs.find(tab => tab.getAttribute('aria-selected') === 'true');
          const currentIndex = tabs.indexOf(currentTab);
          
          if (currentIndex > 0) {
            tabs[currentIndex - 1].click();
          }
        });
        
        // Navigate to next tab
        nextBtn.addEventListener('click', () => {
          const tabs = Array.from(tabsContainer.querySelectorAll('.tab'));
          const currentTab = tabs.find(tab => tab.getAttribute('aria-selected') === 'true');
          const currentIndex = tabs.indexOf(currentTab);
          
          if (currentIndex < tabs.length - 1) {
            tabs[currentIndex + 1].click();
          }
        });
        
        // Update button states based on current tab
        const updateNavigationButtons = () => {
          const tabs = Array.from(tabsContainer.querySelectorAll('.tab'));
          const currentTab = tabs.find(tab => tab.getAttribute('aria-selected') === 'true');
          const currentIndex = tabs.indexOf(currentTab);
          
          // Disable prev button on first tab
          prevBtn.disabled = (currentIndex === 0);
          
          // Disable next button on last tab
          nextBtn.disabled = (currentIndex === tabs.length - 1);
        };
        
        // Update on load and on tab changes
        updateNavigationButtons();
        Bus.on?.('tab-change', updateNavigationButtons);
        
        // Also update after a small delay to catch dynamic tab rendering
        setTimeout(updateNavigationButtons, 500);
      }
    }
    
    // Preview minimize/show functionality (mobile only)
    if (isMobile()) {
      const previewPane = document.querySelector('.right-pane');
      const centerPane = document.querySelector('.center-pane');
      const previewMinimizeBtn = document.getElementById('previewMinimizeBtn');
      const showPreviewBtn = document.getElementById('showPreviewBtn');
      
      // Dynamically adjust center pane padding to accommodate preview pane
      function adjustCenterPanePadding() {
        if (centerPane && previewPane) {
          const previewHeight = previewPane.offsetHeight;
          const previewIsVisible = previewPane.style.display !== 'none';
          
          if (previewIsVisible) {
            // Add padding equal to preview height + 20px buffer
            centerPane.style.paddingBottom = `${previewHeight + 20}px`;
          } else {
            // Remove padding when preview is hidden
            centerPane.style.paddingBottom = '0';
          }
        }
      }
      
      // Adjust on load
      adjustCenterPanePadding();
      
      // Adjust on window resize
      window.addEventListener('resize', adjustCenterPanePadding);
      
      // Adjust when preview updates
      Bus.on?.('preview-update', adjustCenterPanePadding);
      
      if (previewMinimizeBtn && showPreviewBtn && previewPane) {
        // Minimize preview and show "Show Preview" button
        previewMinimizeBtn.addEventListener('click', () => {
          previewPane.style.display = 'none';
          showPreviewBtn.style.display = 'block';
          adjustCenterPanePadding(); // Update padding when minimized
        });
        
        // Show preview and hide "Show Preview" button
        showPreviewBtn.addEventListener('click', () => {
          previewPane.style.display = 'block';
          showPreviewBtn.style.display = 'none';
          // Use setTimeout to ensure display change is applied before measuring
          setTimeout(adjustCenterPanePadding, 10);
        });
      }
    }
  </script>

</body>
</html>
