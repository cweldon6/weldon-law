<!doctype html>
<html lang="en">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Intake Form Test</title>

<form id="intakeForm" novalidate>
  <input type="hidden" name="siteKey" id="siteKey" value="WL5616!SecureKey" />

  <!-- Honeypot: hidden, no autofill, no tab stop -->
  <div style="position:absolute; left:-9999px; top:-9999px; height:0; overflow:hidden;">
    <label aria-hidden="true">Leave blank</label>
    <input type="text" name="company" id="company" autocomplete="off" inputmode="none" tabindex="-1" />
  </div>

  <label>First name
    <input id="first-name" name="first-name" autocomplete="given-name" required />
  </label>

  <label>Last name
    <input id="last-name" name="last-name" autocomplete="family-name" required />
  </label>

  <label>Email
    <input id="email" name="email" type="email" autocomplete="email" required />
  </label>

  <label>Phone
    <input id="phone" name="phone" type="tel" autocomplete="tel" />
  </label>

  <label>Street
    <input id="street" name="street" autocomplete="street-address" />
  </label>

  <label>City
    <input id="city" name="city" autocomplete="address-level2" />
  </label>

  <label>State
    <select id="state" name="state" autocomplete="address-level1">
      <option value="">Select…</option>
      <option>AL</option><option>AK</option><option>AZ</option><option>AR</option>
      <option>CA</option><option>CO</option><option>CT</option><option>DE</option>
      <option>FL</option><option>GA</option><option>HI</option><option>ID</option>
      <option>IL</option><option>IN</option><option>IA</option><option>KS</option>
      <option>KY</option><option>LA</option><option>ME</option><option>MD</option>
      <option>MA</option><option>MI</option><option>MN</option><option>MS</option>
      <option>MO</option><option>MT</option><option>NE</option><option>NV</option>
      <option>NH</option><option>NJ</option><option>NM</option><option>NY</option>
      <option>NC</option><option>ND</option><option>OH</option><option>OK</option>
      <option>OR</option><option>PA</option><option>RI</option><option>SC</option>
      <option>SD</option><option>TN</option><option>TX</option><option>UT</option>
      <option>VT</option><option>VA</option><option>WA</option><option>WV</option>
      <option>WI</option><option>WY</option>
    </select>
  </label>

  <label>ZIP
    <input id="zip" name="zip" inputmode="numeric" autocomplete="postal-code" />
  </label>

  <label>Interest
    <select id="interest" name="interest">
      <option value="">Select…</option>
      <option value="guardianship">Guardianship</option>
      <option value="ltc">LTC</option>
      <option value="estate">Estate</option>
      <option value="probate">Probate</option>
      <option value="other">Other</option>
    </select>
  </label>

  <label>Message
    <textarea id="message" name="message" rows="5"></textarea>
  </label>

  <button id="submitBtn" type="submit">Send</button>
  <div id="status" aria-live="polite" style="margin-top:.5rem;"></div>
</form>

<script>
/* Your live Flow URL */
const FLOW_URL = "https://prod-121.westus.logic.azure.com:443/workflows/2fd109379c324cd5bbab1546b34dca3c/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=GH5F3oVR83EzQ2fzn0l0yUzqs9bmVpHFZP0D0lJgBV8";

/* Utilities */
function digitsOnly(s) { return (s || '').replace(/[^\d]/g, ''); }
function trimLeadingOne(d) { return (d.length === 11 && d.startsWith('1')) ? d.slice(1) : d; }

/* Optional: format phone on blur (cosmetic only) */
document.getElementById('phone').addEventListener('blur', function () {
  const digs = trimLeadingOne(digitsOnly(this.value));
  if (digs.length === 10) this.value = `(${digs.slice(0,3)}) ${digs.slice(3,6)}-${digs.slice(6)}`;
});

document.getElementById('intakeForm').addEventListener('submit', submitIntake);

async function submitIntake(e) {
  e.preventDefault();
  const form = e.target;
  const btn = document.getElementById('submitBtn');
  const status = document.getElementById('status');

  btn.disabled = true;
  status.textContent = 'Sending…';

  /* collect + normalize */
  const data = {
    siteKey: document.getElementById('siteKey').value || '',
    company: form.elements['company']?.value || '', // honeypot
    "first-name": form.elements['first-name'].value.trim(),
    "last-name": form.elements['last-name'].value.trim(),
    email: form.elements['email'].value.trim(),
    phone: trimLeadingOne(digitsOnly(form.elements['phone'].value)),
    street: form.elements['street'].value.trim(),
    city: form.elements['city'].value.trim(),
    state: form.elements['state'].value.trim(),
    zip: form.elements['zip'].value.trim(),
    interest: form.elements['interest'].value.trim(),
    message: form.elements['message'].value.trim()
  };

  try {
    const res = await fetch(FLOW_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data),
      mode: 'cors',
      credentials: 'omit'
    });

    /* Debug: always see what Flow returned */
    const raw = await res.clone().text();
    console.debug('Flow POST status:', res.status, 'raw body:', raw);

    let payload = null;
    try { payload = JSON.parse(raw); } catch { /* not JSON */ }

    if (res.ok && payload?.success) {
      status.textContent = 'Thanks — your message has been sent.';
      form.reset();
    } else {
      status.textContent = (payload?.message)
        ? `Error: ${payload.message}`
        : `Something went wrong. (HTTP ${res.status})`;
    }
  } catch (err) {
    console.error('Network/Fetch error:', err);
    status.textContent = 'Network error. Please try again.';
  } finally {
    btn.disabled = false;
  }
}
</script>
</html>
